    {% load static %}

    <div id="edit_featured_products" class="panel_data" style="display: none;">
        <div class="panel panel_data-content">
            <div class="panel-body" style="display: flex; flex-direction: column; gap: 20px;">
                {% for slot in featured_slots_data %}
                    <div class="featured-product-selector">
                        <label for="slot_{{ slot.slot_num }}">Produit nÂ°{{ slot.slot_num }}</label>
                        <select class="featured-slot" id="slot_{{ slot.slot_num }}" data-slot="{{ slot.slot_num }}">
                            <option value="">â€” Choisir un produit â€”</option>
                            {% for p in all_products %}
                                <option value="{{ p.id }}" {% if slot.product and slot.product.id == p.id %}selected{% endif %}>
                                    {{ p.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                {% endfor %}
                <button class="save-featured-btn" onclick="saveFeaturedProducts()">ðŸ’¾ Enregistrer</button>
            </div>
        </div>
    </div>

    <section id="nouvelle-collection" class="featured-products">
        <h2 class="section-title" onclick="openModal('edit_featured_products')" style="cursor: pointer;">NOUVELLE COLLECTION</h2>

        {% if featured_1 %}
            <div class="product-layout-container" id="mise-en-avant-1">
                <div class="product-image-column">
                    {% if featured_1.main_image %}
                        <img src="{{ featured_1.main_image.url }}" alt="{{ featured_1.name }}" class="main-product-image">
                    {% endif %}
                </div>

                <div class="product-text-column">
                    <h3>{{ featured_1.name }}</h3>
                    <p class="description">{{ featured_1.description }}</p>
                    <p class="price">{{ featured_1.price }} â‚¬</p>

                    <div class="size-selector-dropdown">
                        <div class="custom-select-wrapper">
                            <select name="size" required>
                                <option value="" disabled selected>SÃ©lectionner la taille</option>
                                {% for size in featured_1.sizes.all %}
                                    <option value="{{ size.size }}" {% if size.is_out_of_stock %}disabled{% endif %}>
                                        {{ size.size }}{% if size.is_out_of_stock %} (Rupture){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            <span class="custom-arrow"></span>
                        </div>
                    </div>

                    <a href="#" class="add-to-cart-btn">Ajouter au panier</a>
                    <a href="#" class="contact-us-btn">Contactez-nous</a>

                    <div class="product-services-accordion">
                        <div class="accordion-item">
                            <button class="accordion-header">
                                <span class="accordion-title">DÃ©tails du produit</span>
                                <span class="accordion-icon">+</span>
                            </button>
                            <div class="accordion-content">
                                <ul>
                                    {% for detail in featured_1.details.all %}
                                        <li>{{ detail.content }}</li>
                                    {% empty %}
                                        <li>Aucun dÃ©tail renseignÃ©.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <button class="accordion-header">
                                <span class="accordion-title">Livraison et Retours</span>
                                <span class="accordion-icon">+</span>
                            </button>
                            <div class="accordion-content">
                                <p>{{ delivery_info.title }}</p>
                                <p>{{ delivery_info.content }}</p>
                            </div>
                        </div>
                    </div>

                    <a href="#" class="size-guide-link" style="text-align: center;">Guide des tailles</a>
                </div>

                <div class="thumbnail-column">
                    <div class="thumbnail-gallery">
                        {% if featured_1.main_image %}
                            <img src="{{ featured_1.main_image.url }}" class="thumbnail-image active">
                        {% endif %}
                        {% for image in featured_1.images.all %}
                            <img src="{{ image.image.url }}" class="thumbnail-image">
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}


        {% if featured_2 %}
            <div class="product-layout-container layout-reversed" id="mise-en-avant-2"> 
                <div class="thumbnail-column">
                    <div class="thumbnail-gallery">
                        {% for image in featured_2.images.all %}
                            <img src="{{ image.image.url }}" class="thumbnail-image {% if forloop.first %}active{% endif %}">
                        {% endfor %}
                    </div>
                </div>
                <div class="product-text-column">
                    <h3>{{ featured_2.name }}</h3>
                    <p class="description">{{ featured_2.description|default:"" }}</p>
                    <p class="price">{{ featured_2.price }} â‚¬</p>
                    <div class="size-selector-dropdown">
                        <div class="custom-select-wrapper">
                            <select name="size" required>
                                <option value="" disabled selected>SÃ©lectionner la taille</option>
                                {% for size in featured_2.sizes.all %}
                                    <option value="{{ size.size }}" {% if size.is_out_of_stock %}disabled{% endif %}>
                                        {{ size.size }}{% if size.is_out_of_stock %} (Rupture){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            <span class="custom-arrow"></span>
                        </div>
                    </div>
                    <a href="#" class="add-to-cart-btn">Ajouter au panier</a>
                    <a href="#" class="contact-us-btn">Contactez-nous</a>
                    <div class="product-services-accordion">
                        <div class="accordion-item">
                            <button class="accordion-header"><span class="accordion-title">DÃ©tails du produit</span><span class="accordion-icon">+</span></button>
                            <div class="accordion-content">
                                <ul>
                                    {% for detail in featured_2.details.all %}
                                        <li>{{ detail.content }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <button class="accordion-header"><span class="accordion-title">Livraison et Retours</span><span class="accordion-icon">+</span></button>
                            <div class="accordion-content">
                                <p>{{ delivery_info.title|default:"Livraison standard offerte." }}</p>
                                <p>{{ delivery_info.content|default:"Retour sous 30 jours." }}</p>
                            </div>
                        </div>
                    </div>
                    <a href="#" class="size-guide-link" style="text-align: center;">Guide des tailles</a>
                </div>
                <div class="product-image-column">
                    <img src="{{ featured_2.main_image.url }}" alt="{{ featured_2.name }}" class="main-product-image">
                </div>
            </div>
        {% endif %}


        {% if featured_3 %}
            <div class="product-layout-container" id="mise-en-avant-3"> 
                <div class="product-image-column">
                    <img src="{{ featured_3.main_image.url }}" alt="{{ featured_3.name }}" class="main-product-image">
                </div>
                <div class="product-text-column">
                    <h3>{{ featured_3.name }}</h3>
                    <p class="description">{{ featured_3.description|default:"" }}</p>
                    <p class="price">{{ featured_3.price }} â‚¬</p>
                    <div class="size-selector-dropdown">
                        <div class="custom-select-wrapper">
                            <select name="size" required>
                                <option value="" disabled selected>SÃ©lectionner la taille</option>
                                {% for size in featured_3.sizes.all %}
                                    <option value="{{ size.size }}" {% if size.is_out_of_stock %}disabled{% endif %}>
                                        {{ size.size }}{% if size.is_out_of_stock %} (Rupture){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            <span class="custom-arrow"></span>
                        </div>
                    </div>
                    <a href="#" class="add-to-cart-btn">Ajouter au panier</a>
                    <a href="#" class="contact-us-btn">Contactez-nous</a>
                    <div class="product-services-accordion">
                        <div class="accordion-item">
                            <button class="accordion-header"><span class="accordion-title">DÃ©tails du produit</span><span class="accordion-icon">+</span></button>
                            <div class="accordion-content">
                                <ul>
                                    {% for detail in featured_3.details.all %}
                                        <li>{{ detail.content }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <button class="accordion-header"><span class="accordion-title">Livraison et Retours</span><span class="accordion-icon">+</span></button>
                            <div class="accordion-content">
                                <p>{{ delivery_info.title|default:"Livraison standard offerte." }}</p>
                                <p>{{ delivery_info.content|default:"Retour sous 30 jours." }}</p>
                            </div>
                        </div>
                    </div>
                    <a href="#" class="size-guide-link" style="text-align: center;">Guide des tailles</a>
                </div>
                <div class="thumbnail-column">
                    <div class="thumbnail-gallery">
                        {% for image in featured_3.images.all %}
                            <img src="{{ image.image.url }}" class="thumbnail-image {% if forloop.first %}active{% endif %}">
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    </section>

    

    <style>
        .fly-to-cart {
            position: fixed;
            top: var(--start-y);
            left: var(--start-x);
            width: 150px;
            height: auto;
            z-index: 1000;
            border-radius: 50%;
            animation: flyAndRotate 1.5s cubic-bezier(0.2, 0.5, 0.8, 1) forwards;
        }

        @keyframes flyAndRotate {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            20% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--dest-x), var(--dest-y)) scale(0.45) rotate(360deg);
                opacity: 0;
            }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
        40%, 60% { transform: translate3d(3px, 0, 0); }
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .featured-products {
            padding: 60px 40px 100px 40px;
            background-color: #ffffff;
            color: #1c1c1c;
        }

        .product-layout-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 80px;
            gap: 100px; /* Ajout de cette ligne */
        }

        .product-image-column {
            flex: 0 1 55%;
        }

        .product-text-column {
            flex: 0 1 35%;
        }

        .thumbnail-column {
            flex: 0 1 8%;
            max-width: 100px;
        }
        
        .main-product-image {
            width: 100%;
            height: auto;
        }

        .thumbnail-gallery {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .thumbnail-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .thumbnail-image:hover {
            border-color: #ccc;
        }

        .thumbnail-image.active {
            border-color: #1c1c1c;
        }

        .product-text-column {
            display: flex;
            flex-direction: column;
        }

        .product-text-column h3,
        .product-text-column .description,
        .product-text-column .price,
        .size-selector-dropdown,
        .add-to-cart-btn,
        .contact-us-btn,
        .product-services-accordion,
        .size-guide-link {
            max-width: 380px;
            width: 100%;
            margin-left: 0;
            margin-right: auto;
        }

        .product-text-column h3 {
            font-family: 'Raleway', sans-serif;
            font-weight: 500;
            font-size: 1.3rem;
            text-transform: uppercase;
            margin-bottom: 20px;
            background-image: linear-gradient(to right, #009246 33.3%, #333 33.3%, #333 66.6%, #CE2B37 66.6%);
            background-repeat: no-repeat;
            background-size: 100% 1px;
            background-position: bottom left;
            padding-bottom: 10px;
            display: block;
        }

        .product-text-column .description {
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .product-text-column .price {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .size-selector-dropdown {
            margin-top: 25px;
            margin-bottom: 25px;
        }

        .custom-select-wrapper {
            position: relative;
        }

        .custom-select-wrapper select {
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #ccc;
            padding: 11px 15px;
            font-size: 0.85rem;
            color: #1c1c1c;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .custom-select-wrapper select:invalid {
            color: #888;
        }

        .custom-select-wrapper .custom-arrow {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 5px solid #1c1c1c;
            pointer-events: none;
        }

        .add-to-cart-btn,
        .contact-us-btn {
            display: block;
            padding: 14px 20px;
            border-radius: 50px;
            text-decoration: none;
            text-align: center;
            text-transform: uppercase;
            font-size: 0.8rem;
            font-weight: bold;
            letter-spacing: 1.5px;
            border: 1px solid #1c1c1c;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .add-to-cart-btn {
            background-color: #1c1c1c;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .add-to-cart-btn:hover {
            background-color: #ffffff;
            color: #1c1c1c;
        }

        .contact-us-btn {
            background-color: #ffffff;
            color: #1c1c1c;
            margin-bottom: 30px;
        }

        .contact-us-btn:hover {
            background-color: #1c1c1c;
            color: #ffffff;
        }

        .product-services-accordion {
            text-align: left;
            margin-top: 10px;
            margin-bottom: 0;
        }

        .accordion-item {
            border-bottom: 1px solid #eee;
        }

        .accordion-item:first-child {
            border-top: 1px solid #eee;
        }

        .accordion-header {
            width: 100%;
            background-color: transparent;
            border: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            cursor: pointer;
        }

        .accordion-title {
            font-family: 'Tenor Sans', sans-serif;
            text-transform: uppercase;
            font-weight: normal;
            font-size: 0.9rem;
            letter-spacing: 1px;
            color: #1c1c1c;
        }

        .accordion-icon {
            font-size: 1.5rem;
            font-weight: 300;
            color: #1c1c1c;
            transition: transform 0.3s ease;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease;
            font-size: 0.9rem;
            line-height: 1.7;
            color: #333;
            text-align: left;
        }

        .accordion-item.active .accordion-icon {
            transform: rotate(45deg);
        }

        .accordion-item.active .accordion-content {
            padding-bottom: 20px;
        }

        .size-guide-link {
            display: block;
            font-size: 0.8rem;
            text-decoration: underline;
            color: #666;
            text-align: left;
            margin-top: 20px;
        }

        .size-guide-link:hover {
            color: #1c1c1c;
        }

        .product-layout-container.layout-reversed .product-text-column h3,
        .product-layout-container.layout-reversed .product-text-column .description,
        .product-layout-container.layout-reversed .product-text-column .price,
        .product-layout-container.layout-reversed .product-text-column .size-selector-dropdown,
        .product-layout-container.layout-reversed .product-text-column .add-to-cart-btn,
        .product-layout-container.layout-reversed .product-text-column .contact-us-btn,
        .product-layout-container.layout-reversed .product-text-column .product-services-accordion,
        .product-layout-container.layout-reversed .product-text-column .size-guide-link {
            margin-left: auto;
            margin-right: 20;
        }

        .section-title {
            display: flex;
            align-items: center;
            text-align: center;
            font-size: 1.5rem;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 5px;
            margin: 0 auto 100px auto;
            color: #333;
            max-width: 800px;
        }

        .section-title::before, .section-title::after { content: ''; flex: 1; border-bottom: 2px solid; }
        .section-title::before { margin-right: 2em; border-bottom-color: #009246; }
        .section-title::after { margin-left: 2em; border-bottom-color: #CE2B37; }
 
        .featured-product-selector label {
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }
        .featured-product-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .save-featured-btn {
            padding: 10px 20px;
            background-color: black;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            align-self: flex-start;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Correction pour les galeries d'images ---
            const productContainers = document.querySelectorAll('.product-layout-container');

            productContainers.forEach(container => {
                const mainImage = container.querySelector('.main-product-image');
                const thumbnails = container.querySelectorAll('.thumbnail-image');

                if (mainImage && thumbnails.length > 0) {
                    thumbnails.forEach(thumbnail => {
                        thumbnail.addEventListener('click', function() {
                            mainImage.src = this.src;
                            thumbnails.forEach(t => t.classList.remove('active'));
                            this.classList.add('active');
                        });
                    });
                }
            });

            // --- Code pour l'accordÃ©on (ne change pas) ---
            const accordionItems = document.querySelectorAll('.accordion-item');
            accordionItems.forEach(item => {
                const header = item.querySelector('.accordion-header');
                if (header) {
                    header.addEventListener('click', () => {
                        const isActive = item.classList.contains('active');
                        
                        accordionItems.forEach(otherItem => {
                            otherItem.classList.remove('active');
                            const content = otherItem.querySelector('.accordion-content');
                            if (content) content.style.maxHeight = '0';
                            const icon = otherItem.querySelector('.accordion-icon');
                            if (icon) icon.style.transform = 'rotate(0deg)';
                        });

                        if (!isActive) {
                            item.classList.add('active');
                            const content = item.querySelector('.accordion-content');
                            if (content) content.style.maxHeight = content.scrollHeight + 'px';
                            const icon = item.querySelector('.accordion-icon');
                            if (icon) icon.style.transform = 'rotate(45deg)';
                        }
                    });
                }
            });
        });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const accordionItems = document.querySelectorAll('.accordion-item');

            accordionItems.forEach(item => {
                const header = item.querySelector('.accordion-header');
                const content = item.querySelector('.accordion-content');

                header.addEventListener('click', () => {
                    const isActive = item.classList.contains('active');

                    // Optionnel : fermer les autres accordÃ©ons quand on en ouvre un
                    accordionItems.forEach(otherItem => {
                        otherItem.classList.remove('active');
                        otherItem.querySelector('.accordion-content').style.maxHeight = '0';
                    });

                    if (!isActive) {
                        item.classList.add('active');
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                });
            });
        });
    </script>

    <script>
        const openGuideButton = document.getElementById('open-size-guide');
        const closeGuideButton = document.getElementById('close-size-guide');
        const sizeGuidePanel = document.getElementById('size-guide-panel');
        const panelOverlay = document.getElementById('panel-overlay');

        function openPanel() {
            panelOverlay.style.display = 'block';
            sizeGuidePanel.classList.add('open');
        }

        function closePanel() {
            panelOverlay.style.display = 'none';
            sizeGuidePanel.classList.remove('open');
        }

        openGuideButton.addEventListener('click', function(e) {
            e.preventDefault();
            openPanel();
        });

        closeGuideButton.addEventListener('click', closePanel);
        panelOverlay.addEventListener('click', closePanel);
    </script>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const productContainers = document.querySelectorAll('.product-layout-container');
            productContainers.forEach(container => {
                const mainImage = container.querySelector('.main-product-image');
                const thumbnails = container.querySelectorAll('.thumbnail-image');

                if (mainImage && thumbnails.length > 0) {
                    thumbnails.forEach(thumbnail => {
                        thumbnail.addEventListener('click', function() {
                            mainImage.src = this.src;
                            thumbnails.forEach(t => t.classList.remove('active'));
                            this.classList.add('active');
                        });
                    });
                }
            });

            // --- 2. GESTION DES ACCORDÃ‰ONS ---
            const accordionItems = document.querySelectorAll('.accordion-item');
            accordionItems.forEach(item => {
                const header = item.querySelector('.accordion-header');
                if (header) {
                    header.addEventListener('click', () => {
                        const isActive = item.classList.contains('active');
                        
                        accordionItems.forEach(otherItem => {
                            otherItem.classList.remove('active');
                            const content = otherItem.querySelector('.accordion-content');
                            if (content) content.style.maxHeight = '0';
                        });

                        if (!isActive) {
                            item.classList.add('active');
                            const content = item.querySelector('.accordion-content');
                            if (content) content.style.maxHeight = content.scrollHeight + 'px';
                        }
                    });
                }
            });

            // --- 3. ANIMATION "AJOUTER AU PANIER" (SANS REMONTÃ‰E) --- âœ¨
            const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
            const cartIconContainer = document.querySelector('.cart-icon-container'); // Assurez-vous que cette classe existe dans votre header
            
            if (addToCartButtons.length > 0 && cartIconContainer) {
                
                const startFlyAnimation = (imageToClone) => {
                    const mainImageRect = imageToClone.getBoundingClientRect();
                    const cartIconRect = cartIconContainer.getBoundingClientRect();

                    const startX = mainImageRect.left + (mainImageRect.width / 2) - 75;
                    const startY = mainImageRect.top + (mainImageRect.height / 2) - 75;
                    const endX = cartIconRect.left + (cartIconRect.width / 2);
                    const endY = cartIconRect.top + (cartIconRect.height / 2);

                    const deltaX = endX - startX;
                    const deltaY = endY - startY;

                    const imgClone = imageToClone.cloneNode(true);
                    
                    imgClone.style.setProperty('--start-x', startX + 'px');
                    imgClone.style.setProperty('--start-y', startY + 'px');
                    imgClone.style.setProperty('--dest-x', deltaX + 'px');
                    imgClone.style.setProperty('--dest-y', deltaY + 'px');

                    document.body.appendChild(imgClone);
                    imgClone.classList.add('fly-to-cart');
                    
                    imgClone.addEventListener('animationend', function() {
                        imgClone.remove();
                        cartIconContainer.classList.add('shake');
                        setTimeout(() => cartIconContainer.classList.remove('shake'), 500);
                        
                        const badge = cartIconContainer.querySelector('.badge-number'); // Cherche le badge Ã  l'intÃ©rieur de l'icÃ´ne
                        if (badge) {
                            let currentCount = parseInt(badge.textContent, 10);
                            badge.textContent = currentCount + 1;
                        }
                    });
                };

                addToCartButtons.forEach(button => {
                    button.addEventListener('click', function(event) {
                        event.preventDefault();
                        const productContainer = button.closest('.product-layout-container');
                        const imageToAnimate = productContainer.querySelector('.main-product-image');
                        
                        if (imageToAnimate) {
                            startFlyAnimation(imageToAnimate);
                        }
                    });
                });
            }
        });
    </script>

    <script>
        function saveFeaturedProducts() {
            const data = {};
            document.querySelectorAll('.featured-slot').forEach(select => {
                data[select.dataset.slot] = select.value;
            });

            fetch('/update-featured-products/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert("Erreur lors de la sauvegarde.");
                }
            });
        }
    </script>
